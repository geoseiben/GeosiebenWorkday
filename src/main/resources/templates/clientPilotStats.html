
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="title">Client Project Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css"/>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Modern Theme Styling */
        body { background: #f4f7fa; font-family: 'Inter', sans-serif; }
        .primary-color { background-color: #1e3a8a; } /* Deep Indigo */
        .text-primary-color { color: #1e3a8a; }

        .card {
            border-radius: .75rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }

        .card-header { 
            background-color: #1e3a8a; 
            background-image: linear-gradient(145deg, #1e3a8a 0%, #254b9e 100%);
            color: #fff; 
            font-weight: 700; 
            font-size: 1.25rem;
            border-bottom: none;
            border-radius: .75rem .75rem 0 0;
            padding: 1rem 1.5rem;
        }
        
        /* Summary Cards Styling */
        .summary-card {
            padding: 1rem;
            border-radius: .5rem;
            background-color: #ffffff;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f4f8; 
            border-left: 4px solid #059669; /* Green Accent (Default) */
        }
        .summary-card-red { border-left: 4px solid #ef4444; } /* Red Accent for Finished */
        .summary-card-blue { border-left: 4px solid #3b82f6; } /* Blue Accent for Active */
        .summary-card h5 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0;
        }
        
        /* Table Styling */
        #enhancedDataTable thead th {
            background-color: #eef2f6; 
            color: #334155;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        #enhancedDataTable tbody tr {
            font-size: 0.9rem; 
            border-bottom: 1px solid #e2e8f0; 
        }
        #enhancedDataTable tbody tr:hover {
            background-color: #f0f4f8 !important;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        /* Right alignment for numeric data in the body */
        #enhancedDataTable tbody td:nth-child(2),
        #enhancedDataTable tbody td:nth-child(3),
        #enhancedDataTable tbody td:nth-child(4),
        #enhancedDataTable tbody td:nth-child(5) {
            text-align: right;
        }


        /* DataTables Wrapper Styling */
        .dataTables_wrapper {
            background-color: #ffffff; 
            padding: 1rem 1rem 0.5rem 1rem; 
            border-radius: 0 0 .75rem .75rem;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background-color: #1e3a8a !important;
            border-color: #1e3a8a !important;
            color: white !important;
        }

        /* Chart Container Styling */
        #chartContainer {
            background: white;
            padding: 1.5rem;
            border-radius: .75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body >
    <?php include_once('includes/sidebar.php'); ?>
  <div class="container-fluid py-4">
    <div class="card shadow-lg border-0">
      
      <div class="card-header">
          <div class="d-flex align-items-center">
              <span id="header" class="text-truncate">Loading Report...</span>
          </div>
      </div>
      
      <div class="card-body p-4">



        
        <hr/>
            
        <div class="table-responsive" id="dataTableWrapper" style="display:none;">
            <h4 class="text-primary-color mb-3"><i class="fas fa-table me-2"></i> Detailed Client Data</h4>
          <table id="enhancedDataTable" class="table table-hover w-100">
            <thead>
              <tr>
                <th>Client Name</th>
                <th class="text-end">Client Id</th>
                <th class="text-end">Active Projects</th>
                <th class="text-end">Finished Projects</th>
                <th class="text-end">Total</th>
                 <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="root"></tbody>
          </table>
        </div>

        <div id="messageContainer" class="text-center p-5 font-semibold rounded-lg mb-4" style="display: none;"></div>
        
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
  $(document).ready(function () {
      
      // Mock the current date (as it's PHP in the original)
      const date = new Date().toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}).replace(/ /g, '-');

      const header = $('#header');
      const root = $('#root');
      const dataTableWrapper = $('#dataTableWrapper');
      const chartContainer = $('#chartContainer');
      const messageContainer = $('#messageContainer');
      
      // New summary elements
      const summaryClientCount = $('#summaryClientCount');
      const summaryActiveProjects = $('#summaryActiveProjects'); 
      const summaryFinishedProjects = $('#summaryFinishedProjects'); 

      // Function to display an error/info message and hide the table/chart
      function displayMessage(message, isError = false) {
          const colorClass = isError 
              ? 'bg-danger-subtle text-danger border-danger-subtle' 
              : 'bg-warning-subtle text-warning-emphasis border-warning-subtle';
          const iconClass = isError
              ? 'fas fa-exclamation-circle' 
              : 'fas fa-info-circle'; 
          
          const iconHtml = `<i class="${iconClass} text-2xl me-3 align-middle"></i>`;

          dataTableWrapper.hide(); 
          chartContainer.hide();
          messageContainer.show() 
                            .html(`<div class="d-flex align-items-center justify-content-center">${iconHtml}<span>${message}</span></div>`)
                            .removeClass() 
                            .addClass(`text-center p-4 font-semibold rounded-lg mb-4 border ${colorClass}`);
      }

      // Calculate Grand Total hours (Adjusted to calculate project counts based on the assumed data structure)
      function calculateGrandTotalProjects(dataset) {
          let totalActive = 0;
          let totalFinished = 0;
          let grandTotal = 0;
          
          dataset.forEach(p => {
              // Assume 'qcHours' is Active Projects and 'deliveryHours' is Finished Projects
              const active = parseFloat(p.qcHours) || 0;
              const finished = parseFloat(p.deliveryHours) || 0;
              
              totalActive += active;
              totalFinished += finished;
              grandTotal += active + finished;
          });
          
          return {
            clientCount: dataset.length,
            totalActive: totalActive,
            totalFinished: totalFinished,
            grandTotal: grandTotal
          };
      }
      
      // 2️⃣ Function to draw the chart
      let clientChart; // Variable to hold the chart instance
      function drawChart(dataset) {
          const labels = dataset.map(p => p.clientname);
          const activeProjects = dataset.map(p => p.In_Progress); // Active Projects
          const finishedProjects = dataset.map(p => p.Finished ); // Finished Projects
          console.log({labels,activeProjects,finishedProjects});

          const ctx = document.getElementById('clientProjectChart').getContext('2d');

          // Destroy existing chart instance if it exists
          if (clientChart) {
              clientChart.destroy();
          }

          clientChart = new Chart(ctx, {
              type: 'bar', // Bar chart for comparison
              data: {
                  labels: labels,
                  datasets: [
                      {
                          label: 'Active Projects',
                          data: activeProjects,
                          backgroundColor: 'rgba(59, 130, 246, 0.7)', // Blue
                          borderColor: 'rgba(59, 130, 246, 1)',
                          borderWidth: 1
                      },
                      {
                          label: 'Finished Projects',
                          data: finishedProjects,
                          backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
                          borderColor: 'rgba(239, 68, 68, 1)',
                          borderWidth: 1
                      }
                  ]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      x: {
                          stacked: true, // Stack active and finished projects
                          title: {
                              display: true,
                              text: 'Client Name'
                          }
                      },
                      y: {
                          stacked: true,
                          beginAtZero: true,
                          title: {
                              display: true,
                              text: 'Number of Projects'
                          },
                          ticks: {
                            // Ensure Y-axis is integers for project count
                            precision: 0
                          }
                      }
                  },
                  plugins: {
                      title: {
                          display: false,
                          text: 'Project Status by Client'
                      },
                      tooltip: {
                          mode: 'index',
                          intersect: false
                      },
                      legend: {
                          position: 'bottom',
                      }
                  }
              }
          });
          
          chartContainer.css('height', '400px').show(); // Set height for responsiveness and show
      }


      // 1️⃣ Fetch data from your backend
      $.ajax({
          // NOTE: I am using 'mock_clients_data.json' for demonstration. 
          // You should revert this to your original endpoint: 'api/projDashboard.php'
          url: 'api/projDashboard.php', // Assuming this endpoint is set up
          type: 'POST',
          data:{action:'getClientsData'},
          dataType: 'json',
          success: function (res) {
              if (res && res.length > 0) {
                  const totals = calculateGrandTotalProjects(res);
                  // Update Summary Bar
                  summaryClientCount.text(totals.clientCount);
                  summaryActiveProjects.text(totals.totalActive.toFixed(0));
                  summaryFinishedProjects.text(totals.totalFinished.toFixed(0));
                  
                  populateTable(res);
                  //drawChart(res); // Draw the chart
                  

                  // Initialize DataTable *after* data is populated
                  $('#enhancedDataTable').DataTable({
                      responsive: true,
                      paging: true,
                      searching: true,
                      ordering: true,
                      info: true,
                  });
                  dataTableWrapper.show(); // Ensure table is visible
                  messageContainer.hide();
              } else {
                  // No data found scenario
                  header.html(`Project Report as on ${date}`); 
                  displayMessage("No client data found for this report.", false);
                  summaryClientCount.text(`0`);
                  summaryActiveProjects.text(`0`);
                  summaryFinishedProjects.text(`0`);
              }
          },
          error: function (err) {
              header.html(`Report Loading Failed as on ${date}`); 
              displayMessage("Error fetching data. Please check the network connection or API endpoint.", true);
              summaryClientCount.text(`---`);
              summaryActiveProjects.text(`---`);
              summaryFinishedProjects.text(`---`);
          }
      });


      // 3️⃣ Populate table with processed data
      function populateTable(dataset) {
          let output = '';
          let projectName = 'Client Wise Project Report'; // Better default title

          dataset.forEach(p => {
              // Re-mapping the hours fields to project counts for the table display
              const active = (p.In_Progress) || 0;
              const finished = (p.Finished) || 0;
              const total = (p.projectsCount) || 0;

              // Link to client category wise data
              const clientLink = `<a href="projectsByClient.php?clientId=${p.cid}&clientName=${p.clientname}" class="text-primary-color fw-semibold text-decoration-italic">${p.clientname}</a>`;
        const viewHoursLink = `<a href="clientHoursByMonth.php?clientId=${p.cid}&clientName=${encodeURIComponent(p.clientname)}" class="btn btn-sm btn-primary" title="View Detailed Time Sheets for this Client">
                                        <i class="far fa-clock me-1"></i> View Hours
                                     </a>`;
              output += `
                  <tr>
                      <td class="align-middle">${clientLink}</td>
                      <td class="align-middle">${p.clientId}</td>
                      <td class="align-middle text-end">${active}</td>
                      <td class="align-middle text-end">${finished}</td>
                      <td class="align-middle text-end fw-bold">${total}</td>
                        <td class="align-middle text-end fw-bold">${viewHoursLink}</td>
                  </tr>`;
          });
                    // Updated header construction
          header.html(`
            <div class="d-flex align-items-center">
              <button class="btn btn-outline-light me-3 border-2" onclick="window.history.back()" title="Go Back">
                  <i class="fas fa-arrow-left"></i>
              </button>
              <span class="text-truncate">${projectName} as on ${date}</span>
            </div>`);
          root.html(output);
      }
  });
  </script>
</body>
</html>
