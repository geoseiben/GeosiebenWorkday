<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>


  <title>Leave Management | Admin Portal</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --brand-primary: #6366f1;
      --brand-primary-soft: #f5f3ff;
      --brand-secondary: #4f46e5;
      --brand-success: #10b981;
      --brand-danger: #ef4444;
      --bg-main: #f8fafc;
      --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --border-color: #e2e8f0;
    }

    body { background: var(--bg-main); font-family: 'Inter', sans-serif; color: #0f172a; -webkit-font-smoothing: antialiased; }
    h1, h2, h3, h4, h5, .header-font { font-family: 'Plus Jakarta Sans', sans-serif; letter-spacing: -0.03em; }

    /* Ensure dropdowns appear above table elements */
    .dropdown-menu { z-index: 1060 !important; border: 1px solid var(--border-color); box-shadow: var(--card-shadow); }

    .page-header { padding: 1rem 0; background: #ffffff; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; }
    .glass-card { background: #ffffff; border: 1px solid var(--border-color); box-shadow: var(--card-shadow); overflow: hidden; margin-top: 0.1rem; border-radius: 12px; }
    .group:hover .group-hover\:visible {
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 9999 !important;
      display: block !important;
    }

    /* Fix for potential Tailwind Preflight conflict */
    .invisible {
      display: none;
    }
    .group:hover .invisible {
      display: block;
    }
    #enhancedDataTable thead th {
      background: #fdfdfe;
      color: #475569;
      font-weight: 700;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .main-row { transition: all 0.2s ease; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
    .main-row:hover { background-color: #f8fafc !important; }
    .main-row.shown { background-color: var(--brand-primary-soft) !important; box-shadow: inset 4px 0 0 var(--brand-primary); }

    .employee-photo { width: 40px; height: 40px; border-radius: 10px; object-fit: cover; border: 1px solid #e2e8f0; }
    .status-pill { padding: 6px 14px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; display: inline-flex; align-items: center; gap: 6px; text-transform: uppercase; }
    .pill-pending { background: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; }

    .child-wrapper { padding: 0; background: #fcfcfd; overflow: hidden; animation: expandRow 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes expandRow { from { max-height: 0; opacity: 0; } to { max-height: 800px; opacity: 1; } }

    .expansion-content { padding: 2rem; background: linear-gradient(180deg, var(--brand-primary-soft) 0%, #ffffff 100%); }
    .detail-card { background: #ffffff; border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); height: 100%; }
    .action-panel { background: #ffffff; border: 1px solid var(--brand-primary); border-radius: 16px; padding: 1.5rem; }

    .text-label { color: #64748b; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem; }
    .text-value { color: #1e293b; font-weight: 600; font-size: 0.9rem; }

    .btn-action { border-radius: 10px; padding: 12px 20px; font-weight: 700; font-size: 0.85rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; width: 100%; border: none; }
    .btn-approve { background: var(--brand-primary); color: white; }
    .btn-reject { background: #fee2e2; color: #b91c1c; }

    .session-tag { font-size: 0.65rem; background: #e2e8f0; color: #475569; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-right: 4px; }
    .dataTables_filter input { border-radius: 10px !important; border: 1px solid #cbd5e1 !important; padding: 8px 16px !important; }
  </style>
</head>
<body>

<header th:replace="~{includes/header :: header}"></header>

<div class="container-fluid py-4">

  <div class="glass-card">
    <div style="margin-left:10px; margin-top:10px;">
      <h2 class="fw-bold text-slate-800 mb-1">Leave Requests</h2>
    </div>
    <div class="table-responsive">
      <table id="enhancedDataTable" class="table w-100 mb-0">
        <thead>
        <tr>
          <input type="hidden" id="csrfToken" name="_csrf" th:value="${_csrf.token}" />
          <th>Employee</th>
          <th>Absence Type</th>
          <th>Duration & Sessions</th>
          <th class="text-end">Status</th>
        </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>

<script>
  $(document).ready(function() {
    let leaveTable;

    fetchData();

    function fetchData() {
      $.ajax({
        url: '/admin/pendingrequests',
        type: 'GET',
        dataType: 'json',
        success: function(res) {
          renderTable(res);
          $('#queueCount').text(res ? res.length : 0);
        },
        error: function() {
          $('#tableBody').html('<tr><td colspan="4" class="text-center py-5 text-muted"><i class="fas fa-plug me-2"></i>Service Unavailable</td></tr>');
        }
      });
    }

    function formatDate(dateStr) {
      if(!dateStr) return 'N/A';
      let date = new Date(dateStr);
      const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      let day = String(date.getDate()).padStart(2, '0');
      let month = months[date.getMonth()];
      let year = date.getFullYear();
      return `${day}-${month}-${year}`;
    }

    function renderTable(data) {
      if ($.fn.DataTable.isDataTable('#enhancedDataTable')) {
        $('#enhancedDataTable').DataTable().destroy();
      }

      const $tbody = $('#tableBody');
      $tbody.empty();

      if (!data || data.length === 0) {
        $tbody.html('<tr><td colspan="4" class="text-center py-5 text-muted">All clear! No pending requests.</td></tr>');
        return;
      }

      data.forEach(item => {
        // Ensure ID is passed to the row for easier targeting
        $tbody.append(`
                <tr class="main-row" data-id="${item.id}" data-full-info='${JSON.stringify(item).replace(/'/g, "&apos;")}'>
                    <td class="ps-4">
                        <div class="d-flex align-items-center gap-3">
                            <img src="${item.image || ''}"
                                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(item.employeename)}&background=6366f1&color=fff&bold=true'"
                                 class="employee-photo">
                            <div>
                                <div class="fw-bold" style="font-size: 0.9rem;">${item.employeename}</div>
                                <div class="text-muted small">EID: ${item.eid}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="fw-semibold" style="font-size: 0.85rem;">${item.leavetype}</div>
                        <div class="text-muted small text-truncate" style="max-width: 200px;">${item.reason || 'No summary'}</div>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <div class="fw-bold" style="font-size: 0.85rem;">
                                ${formatDate(item.fromdate)} <span class="text-muted mx-1">to</span> ${formatDate(item.todate)}
                            </div>
                            <div class="d-flex align-items-center mt-1">
                                <span class="session-tag">${item.fromSession || 'S1'}</span>
                                <i class="fas fa-arrow-right extra-small text-muted mx-1" style="font-size: 0.6rem;"></i>
                                <span class="session-tag">${item.toSession || 'S2'}</span>
                                <span class="text-primary small fw-bold ms-2">${item.days} Day(s)</span>
                            </div>
                        </div>
                    </td>
                    <td class="text-end pe-4 align-middle">
                        <span class="status-pill pill-pending">
                            <i class="fas fa-spinner fa-spin"></i> Pending
                        </span>
                    </td>
                </tr>
            `);
      });

      leaveTable = $('#enhancedDataTable').DataTable({
        responsive: true,
        pageLength: 10,
        order: [],
        dom: '<"d-flex justify-content-between align-items-center p-4 border-bottom"f>rt<"d-flex justify-content-between align-items-center p-4"ip>',
        language: { search: "", searchPlaceholder: "Search requests..." }
      });

      $('#enhancedDataTable tbody').off('click').on('click', 'tr.main-row', function() {
        const tr = $(this);
        const row = leaveTable.row(tr);

        if (row.child.isShown()) {
          row.child.hide();
          tr.removeClass('shown');
        } else {
          leaveTable.rows().every(function() {
            if (this.child.isShown()) {
              this.child.hide();
              $(this.node()).removeClass('shown');
            }
          });

          const info = JSON.parse(tr.attr('data-full-info'));
          row.child(renderChild(info)).show();
          tr.addClass('shown');
        }
      });
    }

    function renderChild(d) {
      return `
            <div class="child-wrapper">
                <div class="expansion-content">
                    <div class="row g-4">
                        <div class="col-lg-4">
                            <div class="detail-card">
                                <h6 class="fw-bold mb-3 text-indigo-600" style="font-size: 0.8rem;">Additional Details</h6>
                                <div class="mb-3">
                                    <div class="text-label">Applied By</div>
                                    <div class="text-value">${d.appliedBy || 'N/A'}</div>
                                </div>
                                <div class="mb-3">
                                    <div class="text-label">Manager</div>
                                    <div class="text-value">${d.manager || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="detail-card">
                                <h6 class="fw-bold mb-3 text-indigo-600" style="font-size: 0.8rem;">Reason</h6>
                                <div class="bg-slate-50 p-3 rounded-3 h-75 overflow-auto border">
                                    <p class="mb-0 small text-slate-700 fst-italic">"${d.reason || 'No Reason provided.'}"</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="action-panel">
                                <h6 class="fw-bold mb-3" style="font-size: 0.8rem;">APPROVAL DECISION</h6>
                                <textarea id="remarks-${d.id}" class="form-control mb-3" rows="3" placeholder="Add optional remarks..."></textarea>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button class="btn-action btn-approve" onclick="handleUpdate('approve', ${d.id}, this)">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                    </div>


                                    <div class="col-6">
                                        <button class="btn-action btn-reject" onclick="handleUpdate('reject', ${d.id}, this)">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
    }
  });

  async function handleUpdate(action, id, btn) {
    const $btn = $(btn);
    const remarks = $(`#remarks-${id}`).val().trim();

    if (action === 'reject' && !remarks) {
      Swal.fire({ title: 'Justification Needed', text: 'Please provide a reason for the rejection.', icon: 'warning' });
      return;
    }

    $btn.prop('disabled', true).html('<i class="fas fa-circle-notch fa-spin"></i> Processing...');

    // NOTE: Ensure your endpoint 'api/updateLeave.php' is correct for your Java/Thymeleaf backend
    // If using Spring Boot, this would likely be '/api/leaves/update'
    try {
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

      const params = new URLSearchParams();
      params.append("action", action);
      params.append("leaveId", id);
      params.append("remarks", remarks);

      const response = await fetch('/admin/updateLeave', {
        method: 'POST',
        headers: {
          [csrfHeader]: csrfToken
          // No need for Content-Type, fetch will set it automatically for URLSearchParams
        },
        body: params
      });




      const res = await response.json();
console.log(res);
      if (res.status === 'success') {
        Swal.fire({ icon: 'success', title: 'Action Recorded', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });

        const $row = $(`.main-row[data-id="${id}"]`);
        $row.fadeOut(500, function() {
          $('#enhancedDataTable').DataTable().row($row).remove().draw(false);
          const currentCount = parseInt($('#queueCount').text());
          $('#queueCount').text(currentCount > 0 ? currentCount - 1 : 0);
        });
      } else {
        throw new Error(res.message);
      }
    } catch (e) {
      Swal.fire('Error', e.message || 'Server connection failed', 'error');
      $btn.prop('disabled', false).html(action === 'approve' ? '<i class="fas fa-check"></i> Approve' : '<i class="fas fa-times"></i> Reject');
    }
  }
</script>

</body>
</html>